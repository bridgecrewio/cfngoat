AWSTemplateFormatVersion: '2010-09-09'
Description: AWS CloudFormation Template to deploy insecure infrastructure
Parameters:
  CompanyName:
    Description: Company Name
    Type: String
    Default: acme
  Environment: 
    Description: Environment
    Type: String
    Default: dev
  DBName:
    Description: Name of the Database
    Type: String
    Default: db1
  Password: 
    Description: Database Password 
    Type: String
    NoEcho: True
    MinLength: 1
    MaxLength: 41
    AllowedPattern: ^[a-zA-Z0-9]*$
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2

Resources:
  ####################
  ###  EC2 in VPC  ###
  ####################
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone:
        Fn::Select:
        - "0"
        - Fn::GetAZs: ""
      Encrypted: true
      InstanceType: t2.nano
      SecurityGroupIds: 
        - !Ref WebNodeSG
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref WebSubnet
      Tags: 
        - Key: Name
          Value: !Sub "${AWS::AccountId}-${CompanyName}-${Environment}-ec2" 
        - Key: yor_trace
          Value: 595b9b79-bd1e-45fd-a297-d521ebdf15e7
        - Key: git_org
          Value: bridgecrewio
        - Key: git_repo
          Value: cfngoat
        - Key: git_file
          Value: cfngoat.yaml
        - Key: git_commit
          Value: 42153ba22c28f5c0bff388b24a6344137a5dfe26
        - Key: git_modifiers
          Value: jonathan.jozwiak/nimrodkor
        - Key: git_last_modified_at
          Value: "2021-08-23 13:51:41"
        - Key: git_last_modified_by
          Value: nimrodkor@gmail.com
      UserData:
        Fn::Base64: |
          #!/bin/bash
          sudo yum -y update
          sudo yum -y install httpd php php-mysqlnd
          sudo systemctl enable httpd
          sudo systemctl start httpd
          export AWS_DEFAULT_REGION=us-west-2
          echo "<h1>Deployed via CloudFormation</h1>" | sudo tee /var/www/html/index.html
  WebHostStorage:
    # Unencrypted Volume
    Type: AWS::EC2::Volume
    Properties:
      AvailabilityZone:
        Fn::Select:
          - "0"
          - Fn::GetAZs: ""
      Encrypted: true
      #Encrypted: False
      Size: 1
      Tags:
        - Key: Name
          Value: !Sub "${AWS::AccountId}-${CompanyName}-${Environment}-ebs"
        - Key: git_last_modified_by
          Value: nimrodkor@gmail.com
        - Key: yor_trace
          Value: 838685b6-8fac-42eb-9cf4-008dd36216a1
        - Key: git_org
          Value: bridgecrewio
        - Key: git_repo
          Value: cfngoat
        - Key: git_file
          Value: cfngoat.yaml
        - Key: git_commit
          Value: 42153ba22c28f5c0bff388b24a6344137a5dfe26
        - Key: git_modifiers
          Value: jonathan.jozwiak/nimrodkor
        - Key: git_last_modified_at
          Value: "2021-08-23 13:51:41"

